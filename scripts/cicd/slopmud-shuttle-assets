#!/usr/bin/env bash
set -euo pipefail

# AWS CLI needs a region for some calls; default to the stack's region.
export AWS_REGION="${AWS_REGION:-us-east-1}"
export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-$AWS_REGION}"

usage() {
  cat >&2 <<'EOF'
USAGE:
  slopmud-shuttle-assets --env <dev|stg|prd|sandbox> --from-s3 s3://BUCKET/KEY
  slopmud-shuttle-assets --env <dev|stg|prd|sandbox> --from-file /path/to/artifact.tgz
  slopmud-shuttle-assets --env <dev|stg|prd|sandbox> --rewrite-unit --from-file /path/to/artifact.tgz

This script:
- copies the asset tarball into /opt/slopmud/assets/<env>/<sha>/
- extracts it
- installs the slopmud binary into /opt/slopmud/bin/slopmud-<env>
- installs the shard_01 binary into /opt/slopmud/bin/shard-01-<env> when present
- restarts the slopmud and shard services

By default, it does NOT overwrite an existing unit file. This is important because
real deployments often bake critical env/config into the systemd unit.

If the unit is missing, or you pass --rewrite-unit, the script writes a minimal
unit file and enables it.

NOTE:
  Must run as root (use sudo). Intended to be callable by the GitHub Actions runner user
  via a narrow sudoers rule.
EOF
}

if [[ "${EUID:-$(id -u)}" != "0" ]]; then
  echo "ERROR: must run as root (use sudo)" >&2
  exit 2
fi

env_name=""
from_s3=""
from_file=""
rewrite_unit="0"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --env)
      env_name="${2:-}"; shift 2 ;;
    --from-s3)
      from_s3="${2:-}"; shift 2 ;;
    --from-file)
      from_file="${2:-}"; shift 2 ;;
    --rewrite-unit)
      rewrite_unit="1"; shift ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "ERROR: unknown arg: $1" >&2
      usage
      exit 2
      ;;
  esac
done

if [[ -z "$env_name" ]]; then
  echo "ERROR: --env is required" >&2
  usage
  exit 2
fi

if [[ -n "$from_s3" && -n "$from_file" ]]; then
  echo "ERROR: choose only one of --from-s3 or --from-file" >&2
  usage
  exit 2
fi
if [[ -z "$from_s3" && -z "$from_file" ]]; then
  echo "ERROR: one of --from-s3 or --from-file is required" >&2
  usage
  exit 2
fi

case "$env_name" in
  dev)
    service_name="slopmud-dev"
    node_id="2"
    bind="0.0.0.0:4000"
    bin_dst="/opt/slopmud/bin/slopmud-dev"
    shard_service_name="shard-01-dev"
    shard_bind="127.0.0.1:5000"
    shard_bin_dst="/opt/slopmud/bin/shard-01-dev"
    ;;
  sandbox)
    service_name="slopmud-sandbox"
    node_id="9"
    bind="0.0.0.0:4500"
    bin_dst="/opt/slopmud/bin/slopmud-sandbox"
    ;;
  stg)
    service_name="slopmud-stg"
    node_id="3"
    bind="0.0.0.0:4023"
    bin_dst="/opt/slopmud/bin/slopmud-stg"
    shard_service_name="shard-01-stg"
    shard_bind="127.0.0.1:5002"
    shard_bin_dst="/opt/slopmud/bin/shard-01-stg"
    ;;
  prd)
    service_name="slopmud-prd"
    node_id="1"
    bind="0.0.0.0:4200"
    bin_dst="/opt/slopmud/bin/slopmud-prd"
    shard_service_name="shard-01-prd"
    shard_bind="127.0.0.1:5000"
    shard_bin_dst="/opt/slopmud/bin/shard-01-prd"
    ;;
  *)
    echo "ERROR: invalid --env: $env_name (expected dev|stg|prd|sandbox)" >&2
    exit 2
    ;;
esac

unit_name="${service_name}.service"
load_state="$(systemctl show -p LoadState --value "$unit_name" 2>/dev/null || true)"
unit_exists="0"
if [[ -n "$load_state" && "$load_state" != "not-found" ]]; then
  unit_exists="1"
fi

shard_unit_name="${shard_service_name}.service"
shard_load_state="$(systemctl show -p LoadState --value "$shard_unit_name" 2>/dev/null || true)"
shard_unit_exists="0"
if [[ -n "$shard_load_state" && "$shard_load_state" != "not-found" ]]; then
  shard_unit_exists="1"
fi

get_unit_env_var() {
  local unit="$1"
  local var="$2"

  # `systemctl show -p Environment` prints a space-separated list of KEY=VALUE items.
  # Our values don't contain spaces, so tokenization is safe.
  systemctl show -p Environment --value "$unit" 2>/dev/null \
    | tr ' ' '\n' \
    | sed 's/^"//; s/"$//' \
    | sed -n "s/^${var}=//p" \
    | head -n 1
}

maybe_override_from_unit() {
  local unit="$1"
  local env_key="$2"
  local env_var=""
  local execstart=""
  local path_token=""
  local bin_from_unit=""

  if [[ "$unit" == "$unit_name" && "$unit_exists" != "1" ]]; then
    return 0
  fi
  if [[ "$unit" == "$shard_unit_name" && "$shard_unit_exists" != "1" ]]; then
    return 0
  fi

  if [[ "$env_key" == "SLOPMUD_BIND" ]]; then
    env_var="$(get_unit_env_var "$unit" "$env_key" || true)"
    if [[ -n "$env_var" ]]; then
      bind="$env_var"
    fi
  elif [[ "$env_key" == "SHARD_BIND" ]]; then
    env_var="$(get_unit_env_var "$unit" "$env_key" || true)"
    if [[ -n "$env_var" ]]; then
      shard_bind="$env_var"
    fi
  fi

  execstart="$(systemctl show -p ExecStart --value "$unit" 2>/dev/null || true)"
  path_token="$(printf '%s' "$execstart" | grep -oE 'path=[^ ;}]+' | head -n 1 || true)"
  bin_from_unit="${path_token#path=}"
  if [[ -n "$bin_from_unit" && "$bin_from_unit" == /opt/slopmud/bin/* ]]; then
    if [[ "$env_key" == "SLOPMUD_BIND" ]]; then
      bin_dst="$bin_from_unit"
    elif [[ "$env_key" == "SHARD_BIND" ]]; then
      shard_bin_dst="$bin_from_unit"
    fi
  fi
}

if [[ "$unit_exists" == "1" ]]; then
  maybe_override_from_unit "$unit_name" "SLOPMUD_BIND"
fi
if [[ "$shard_unit_exists" == "1" ]]; then
  maybe_override_from_unit "$shard_unit_name" "SHARD_BIND"
fi

if [[ -n "$from_s3" ]] && ! command -v aws >/dev/null 2>&1; then
  echo "ERROR: aws CLI is required for --from-s3 deployments" >&2
  exit 2
fi

sha="unknown"
if [[ -n "$from_s3" ]]; then
  if [[ "$from_s3" != s3://*/* ]]; then
    echo "ERROR: invalid s3 uri: $from_s3" >&2
    exit 2
  fi
  tmp="${from_s3#s3://}"
  bucket="${tmp%%/*}"
  key="${tmp#${bucket}/}"
  sha="$(basename "$(dirname "$key")")"
else
  # Best-effort: use parent dir name if it looks like a sha, else timestamp.
  sha="$(basename "$(dirname "$from_file")")"
  if [[ "$sha" == "." || "$sha" == "/" || -z "$sha" ]]; then
    sha="unknown"
  fi
fi

assets_dir="/opt/slopmud/assets/${env_name}/${sha}"
mkdir -p "$assets_dir"

artifact_dst="${assets_dir}/artifact.tgz"
if [[ -n "$from_s3" ]]; then
  echo "Downloading asset: ${from_s3} -> ${artifact_dst}"
  aws s3 cp "$from_s3" "$artifact_dst"
else
  echo "Copying asset: ${from_file} -> ${artifact_dst}"
  install -m 0644 "$from_file" "$artifact_dst"
fi

echo "Extracting asset into ${assets_dir}"
tar -xzf "$artifact_dst" -C "$assets_dir"

bin_src="${assets_dir}/bin/slopmud"
if [[ ! -x "$bin_src" ]]; then
  echo "ERROR: expected executable at ${bin_src}" >&2
  exit 2
fi

if ! id -u slopmud >/dev/null 2>&1; then
  echo "Creating system user: slopmud"
  useradd --system --home /opt/slopmud --create-home --shell /usr/sbin/nologin slopmud
fi

install -d -m 0755 /opt/slopmud /opt/slopmud/bin /opt/slopmud/assets
chown slopmud:slopmud /opt/slopmud

echo "Installing binary -> ${bin_dst}"
install -m 0755 -o root -g root "$bin_src" "$bin_dst"

bin_shard_src="${assets_dir}/bin/shard_01"
if [[ -x "$bin_shard_src" ]]; then
  echo "Installing shard binary -> ${shard_bin_dst}"
  install -m 0755 -o root -g root "$bin_shard_src" "$shard_bin_dst"
fi

unit_path="/etc/systemd/system/${service_name}.service"
if [[ "$unit_exists" != "1" || "$rewrite_unit" == "1" ]]; then
  if [[ "$unit_exists" == "1" && "$rewrite_unit" == "1" ]]; then
    echo "WARN: rewriting existing unit file: ${unit_path}" >&2
  else
    echo "Writing systemd unit file: ${unit_path}"
  fi

  cat >"$unit_path" <<EOF
[Unit]
Description=slopmud service (env: ${env_name}, sha: ${sha})
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=slopmud
Group=slopmud
WorkingDirectory=/opt/slopmud
Environment=RUST_LOG=slopmud=info
Environment=NODE_ID=${node_id}
Environment=SLOPMUD_BIND=${bind}
Environment=SHARD_ADDR=${shard_bind}
ExecStart=${bin_dst}
Restart=always
RestartSec=2
NoNewPrivileges=true
AmbientCapabilities=CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
EOF
fi

echo "Restarting systemd unit: ${service_name}"
if [[ "$unit_exists" != "1" || "$rewrite_unit" == "1" ]]; then
  systemctl daemon-reload
  systemctl enable --now "${service_name}"
fi
systemctl restart "${service_name}"

port="${bind##*:}"
echo "Listening check (port ${port})"
ss -lnt | grep -qE ":${port}\\b" || { echo "not listening on ${port}" >&2; exit 1; }

if [[ -x "$bin_shard_src" ]]; then
  shard_unit_path="/etc/systemd/system/${shard_service_name}.service"
  if [[ "$shard_unit_exists" != "1" || "$rewrite_unit" == "1" ]]; then
    if [[ "$shard_unit_exists" == "1" && "$rewrite_unit" == "1" ]]; then
      echo "WARN: rewriting existing shard unit file: ${shard_unit_path}" >&2
    else
      echo "Writing shard systemd unit file: ${shard_unit_path}"
    fi

    cat >"$shard_unit_path" <<EOF
[Unit]
Description=slopmud shard_01 (env: ${env_name}, sha: ${sha})
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=slopmud
Group=slopmud
WorkingDirectory=/opt/slopmud
Environment=RUST_LOG=shard_01=info
Environment=SHARD_BIND=${shard_bind}
ExecStart=${shard_bin_dst}
Restart=always
RestartSec=2
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF
  fi

  echo "Restarting systemd unit: ${shard_service_name}"
  if [[ "$shard_unit_exists" != "1" || "$rewrite_unit" == "1" ]]; then
    systemctl daemon-reload
    systemctl enable --now "${shard_service_name}"
  fi
  systemctl restart "${shard_service_name}"

  shard_port="${shard_bind##*:}"
  echo "Listening check (shard port ${shard_port})"
  ss -lnt | grep -qE ":${shard_port}\\b" || { echo "not listening on ${shard_port}" >&2; exit 1; }
fi

echo "OK: ${service_name} deployed (sha=${sha})"
